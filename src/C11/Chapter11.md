11. 云计算

云计算的兴起解决了性能领域的一些老问题，同时也创造了新问题。云环境可以立即创建并按需扩展，而无需构建和管理本地数据中心的典型开销。云还允许更好的部署粒度 - 不同的客户可以根据需要使用服务器的一小部分。但是，这带来了自身的挑战：虚拟化技术的性能开销以及与相邻租户的资源争用。

本章的学习目标是：

■ 了解云计算架构及其性能影响。
■ 了解虚拟化的类型：硬件、作系统和轻量级硬件。
■ 熟悉虚拟化内部结构，包括 I/O 代理的使用和优化技术。
■ 了解每种虚拟化类型下不同工作负载的预期开销。
■ 诊断主机和来宾的性能问题，了解工具使用情况如何根据所使用的虚拟化而变化。

虽然整本书都适用于云性能分析，但本章重点介绍云特有的性能主题：虚拟机管理程序和虚拟化的工作原理、如何将资源控制应用于来宾，以及主机和来宾的可观察性的工作原理。云供应商通常提供自己的自定义服务和 API，此处未涵盖这些服务和 API：请参阅每个云供应商为其自己的服务集提供的文档。

本章由四个主要部分组成：
■ 背景 介绍了一般的云计算架构及其对性能的影响。
■ 硬件虚拟化，其中虚拟机管理程序将多个来宾作系统实例作为虚拟机进行管理，每个实例都运行自己的内核和虚拟化设备。
■本节使用 Xen、KVM 和 Amazon Nitro 管理程序作为示例。
■作系统虚拟化，其中单个内核管理系统，创建彼此隔离的虚拟作系统实例。本节以 Linux 容器为例。
■ 轻量级硬件虚拟化提供了两全其美的解决方案，其中轻量级硬件虚拟化实例使用专用内核运行，具有类似于容器的启动时间和密度优势。本节使用 AWS Firecracker 作为示例管理程序。

虚拟化部分按它们在云中广泛使用的时间排序。例如，Amazon Elastic Compute Cloud （EC2） 在 2006 年提供了硬件虚拟化实例，在 2017 年提供了作系统虚拟化容器 （Amazon Fargate），在 2019 年提供了轻量级虚拟机 （Amazon Firecracker）。

11.1 背景
云计算允许将计算资源作为服务交付，从服务器的一小部分扩展到多服务器系统。云的构建块取决于安装和配置的软件堆栈的数量。本章重点介绍以下云产品，这两种产品都提供服务器实例，这些实例可能是：
硬件实例：也称为基础设施即服务 （IaaS），使用硬件虚拟化提供。每个服务器实例都是一个虚拟机。
OS 实例：用于提供轻量级实例，通常通过 OS 虚拟化。

这些实例可以一起称为服务器实例、云实例或简称为实例。支持这些的云提供商的示例包括 Amazon Web Services （AWS）、Microsoft Azure 和 Google Cloud Platform （GCP）。还有其他类型的云原语，包括函数即服务 （FaaS）（请参见部分 11.5， 其他类型）

总结关键的云术语：云计算描述了实例的动态供应框架工作。一个或多个实例作为物理主机系统的来宾运行。来宾也称为租户，术语 multitenancy 用于描述它们在同一主机上运行。主机可能由运营公有云的云提供商管理，也可能由您的公司管理，仅供内部使用，作为私有云的一部分。一些公司构建了一个跨公有云和私有云的混合云。1 云来宾（租户）由其最终用户管理。

对于硬件虚拟化，一种称为虚拟机管理程序（或虚拟机监视器，VMM）的技术创建和管理虚拟机实例，这些实例显示为专用计算机，并允许安装整个作系统和内核。

通常可以在几分钟或几秒钟内创建 （和销毁） NSTANCES，并立即投入生产使用。通常提供云 API，以便此配置可以由另一个程序自动配对

通过讨论各种与性能相关的主题，可以进一步理解云计算：实例类型、架构、容量规划、存储和多租户。这些将在以下各节中总结。

11.1.1 实例类型
云提供商通常提供不同的实例类型和大小。某些实例类型是通用的，并且在资源之间保持平衡。其他 API 可能针对特定资源进行了优化：内存、CPU、磁盘等。例如，AWS 将类型分为 “families”（用字母缩写）和 generations（数字），目前提供：

■ m5：通用型（平衡型） 
■c5：计算优化型 i3，
■d2：存储型 r4，x1：内存优化型 p1，g3、
■f1：加速计算（GPU、FPGA 等）

每个家庭都有各种大小。例如，AWS m5 系列的范围从 m5.large（2 个 vCPU 和 8 GB 主内存）到 m5.24xlarge（24 个超大型：96 个 vCPU 和 384 GB 主内存）。

通常，各种大小的性价比相当一致，允许客户选择最适合其工作负载的大小。

一些提供商（例如 Google Cloud Platform）还提供自定义机器类型，您可以在其中选择资源量。

由于有这么多选项并且易于重新部署实例，实例类型已经变得像一个可调整的参数，可以根据需要进行修改。与传统的企业模式相比，这是一个很大的改进，即选择和订购公司多年来可能无法改变的物理硬件

11.1.2 可扩展的架构

企业环境历来使用垂直可扩展性方法来处理负载：构建更大的单个系统（大型机）。这种方法有其局限性。计算机可以构建的物理大小存在实际限制（可能受电梯门或集装箱的大小限制），并且随着 CPU 数量的扩展，CPU 缓存一致性以及电源和冷却的难度越来越大。这些限制的解决方案是在许多（可能是小型）系统中扩展负载;这称为水平可扩展性。在企业中，它已用于计算机场和集群，尤其是高性能计算 （HPC，其使用早于云）。

云计算也基于水平可扩展性。图 11.1 显示了一个示例环境，其中包括负载均衡器、Web 服务器、应用程序服务器和数据库。

每个环境层都由一个或多个并行运行的服务器实例组成，并添加了更多服务器实例以处理负载。实例可以单独添加，也可以将架构划分为垂直分区，其中由数据库服务器、应用程序服务器和 Web 服务器组成的组作为单个单元添加。

此模型的一个挑战是传统数据库的部署，其中 1 个数据库实例必须是主数据库。这些数据库（例如 MySQL）的数据可以在逻辑上拆分为称为分片的组，每个组都由自己的数据库（或主/辅助对）管理。分布式数据库架构（如 Riak）动态处理并行执行，将负载分散到可用实例上。现在有专为在云上使用而设计的原生云数据库，包括 Cassandra、CockroachDB、Amazon Aurora 和 Amazon DynamoDB。

由于每个服务器实例的大小通常很小，例如 8 GB（在具有 512 GB 或更多 DRAM 的物理主机上），因此可以使用精细扩展来实现最佳性价比，而不是预先投资于可能大部分处于空闲状态的大型系统。

11.1.3 容量规划
本地服务器可能是一笔巨大的基础设施成本，无论是硬件还是服务合同费用，都可能持续数年。新服务器也可能需要几个月的时间才能投入生产：花费在审批、等待部件可用性、运输、货架、安装和测试上的时间。容量规划至关重要，这样才能购买到适当大小的系统：太小意味着失败，太大意味着代价高昂（而且，对于服务合同，未来几年可能会付出高昂的代价）。还需要进行产能规划，以便提前预测需求增加，以便及时完成冗长的采购程序。
本地服务器和数据中心是企业环境的常态。云计算非常不同。服务器实例成本低廉，几乎可以立即创建和销毁。公司可以根据需要增加他们使用的服务器实例的数量，以应对实际负载，而不是花时间规划可能需要什么。这可以通过云 API 根据性能监控软件的指标自动完成。小型企业或初创公司可以从单个小型实例发展到数千个，而无需像企业环境中预期的那样进行详细的容量规划研究3。

对于成长中的初创公司，另一个需要考虑的因素是代码更改的速度。站点通常每周、每天甚至一天多次更新其生产代码。容量规划研究可能需要数周时间，并且由于它基于性能指标的快照，因此在完成时可能已过时。这与运行商业软件的企业环境不同，后者每年可能更改不超过几次。